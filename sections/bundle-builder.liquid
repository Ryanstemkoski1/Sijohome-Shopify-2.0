{%- liquid
  assign product = all_products[section.settings.product]
  if product == blank
    assign product = all_products[section.settings.product_handle]
  endif
-%}

{%- if product != blank -%}
  {%- assign color_scheme_hash = section.settings.color_scheme.settings.background_gradient | default: section.settings.color_scheme.settings.background | md5 -%}

  {%- if section.settings.enable_anchor -%}
    <div id="Bundle-Form-Anchor" style="position: absolute; top: -100px;"></div>
  {%- endif -%}

  <div class="section-spacing color-scheme color-scheme--{{ section.settings.color_scheme.id }} color-scheme--bg-{{ color_scheme_hash }} {% if section.settings.separate_section_with_border %}bordered-section{% endif %}">
    <div class="container">
      <div class="section-stack">
        {%- if section.settings.subheading != blank or section.settings.heading != blank -%}
          {%- render 'section-header', subheading: section.settings.subheading, heading: section.settings.heading, content: section.settings.content -%}
        {%- endif -%}

        <div class="bundle-builder" data-bundle-product="{{ product.handle }}">
          <div class="bundle-builder__grid">
            <!-- Product Image Gallery -->
            <div class="bundle-builder__gallery">
              {%- if product.featured_media -%}
                <div class="bundle-gallery">
                  <div class="bundle-gallery__main">
                    <img src="{{ product.featured_media | image_url: width: 800 }}" 
                         alt="{{ product.featured_media.alt | escape }}"
                         width="800" height="800" loading="lazy">
                  </div>
                  {%- if product.media.size > 1 -%}
                    <div class="bundle-gallery__thumbnails">
                      {%- for media in product.media limit: 6 -%}
                        <button type="button" class="bundle-gallery__thumb {% if forloop.first %}is-active{% endif %}"
                                data-media-id="{{ media.id }}">
                          <img src="{{ media | image_url: width: 120 }}" 
                               alt="{{ media.alt | escape }}"
                               width="120" height="120" loading="lazy">
                        </button>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            </div>

            <!-- Bundle Configuration -->
            <div class="bundle-builder__form">
              <div class="bundle-details">
                <h3 class="bundle-details__title">{{ product.title }}</h3>
                {%- if product.description != blank -%}
                  <div class="bundle-details__description rte">
                    {{ product.description | truncate: 200 }}
                  </div>
                {%- endif -%}

                <!-- Bundle Options -->
                <form class="bundle-form" data-product-form>
                  {%- if product.has_only_default_variant == false -%}
                    {%- for option in product.options_with_values -%}
                      <div class="bundle-option">
                        <fieldset class="bundle-option__fieldset">
                          <legend class="bundle-option__legend">{{ option.name }}</legend>
                          <div class="bundle-option__buttons">
                            {%- for value in option.values -%}
                              <input type="radio" 
                                     class="bundle-option__input sr-only"
                                     name="option-{{ option.position }}"
                                     id="option-{{ option.position }}-{{ forloop.index }}"
                                     value="{{ value | escape }}"
                                     {% if forloop.first %}checked{% endif %}>
                              <label class="bundle-option__button" 
                                     for="option-{{ option.position }}-{{ forloop.index }}">
                                {{ value }}
                              </label>
                            {%- endfor -%}
                          </div>
                        </fieldset>
                      </div>
                    {%- endfor -%}
                  {%- endif -%}

                  <!-- Bundle Items -->
                  {%- if section.blocks.size > 0 -%}
                    <div class="bundle-items">
                      <h4 class="bundle-items__title">Bundle Includes:</h4>
                      {%- for block in section.blocks -%}
                        {%- case block.type -%}
                          {%- when 'bundle_item' -%}
                            <div class="bundle-item" {{ block.shopify_attributes }}>
                              <div class="bundle-item__content">
                                {%- if block.settings.icon != blank -%}
                                  <div class="bundle-item__icon">
                                    <img src="{{ block.settings.icon | image_url: width: 40 }}" 
                                         alt="{{ block.settings.title | escape }}"
                                         width="40" height="40" loading="lazy">
                                  </div>
                                {%- endif -%}
                                <div class="bundle-item__text">
                                  <h5 class="bundle-item__title">{{ block.settings.title }}</h5>
                                  {%- if block.settings.description != blank -%}
                                    <p class="bundle-item__description">{{ block.settings.description }}</p>
                                  {%- endif -%}
                                </div>
                              </div>
                              {%- if block.settings.value != blank -%}
                                <div class="bundle-item__value">{{ block.settings.value }}</div>
                              {%- endif -%}
                            </div>
                        {%- endcase -%}
                      {%- endfor -%}
                    </div>
                  {%- endif -%}

                  <!-- Bundle Pricing -->
                  <div class="bundle-pricing">
                    <div class="bundle-pricing__comparison">
                      {%- if section.settings.compare_price != blank -%}
                        <div class="bundle-pricing__compare">
                          <span class="bundle-pricing__label">Individual Price:</span>
                          <span class="bundle-pricing__compare-price">${{ section.settings.compare_price }}</span>
                        </div>
                      {%- endif -%}
                      <div class="bundle-pricing__current">
                        <span class="bundle-pricing__label">Bundle Price:</span>
                        <span class="bundle-pricing__price" data-bundle-price>
                          {{ product.price | money }}
                        </span>
                      </div>
                      {%- if section.settings.savings_amount != blank -%}
                        <div class="bundle-pricing__savings">
                          <span class="bundle-pricing__savings-text">
                            You Save: ${{ section.settings.savings_amount }}
                          </span>
                        </div>
                      {%- endif -%}
                    </div>
                  </div>

                  <!-- Add to Cart -->
                  <div class="bundle-actions">
                    <input type="hidden" name="id" data-variant-id value="{{ product.selected_or_first_available_variant.id }}">
                    
                    <button type="submit" 
                            class="bundle-actions__button button button--primary button--full-width"
                            {% unless product.available %}disabled{% endunless %}>
                      {%- if product.available -%}
                        {{ section.settings.button_text | default: 'Add Bundle to Cart' }}
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </button>

                    {%- if section.settings.show_guarantees -%}
                      <div class="bundle-guarantees">
                        <div class="bundle-guarantee">
                          <span class="bundle-guarantee__icon">üöö</span>
                          <span class="bundle-guarantee__text">Free shipping on orders $100+</span>
                        </div>
                        <div class="bundle-guarantee">
                          <span class="bundle-guarantee__icon">üõ°Ô∏è</span>
                          <span class="bundle-guarantee__text">100-night sleep trial</span>
                        </div>
                        <div class="bundle-guarantee">
                          <span class="bundle-guarantee__icon">‚ôªÔ∏è</span>
                          <span class="bundle-guarantee__text">Sustainable materials</span>
                        </div>
                      </div>
                    {%- endif -%}
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    class BundleBuilder extends HTMLElement {
      constructor() {
        super();
        this.form = this.querySelector('[data-product-form]');
        this.priceElement = this.querySelector('[data-bundle-price]');
        this.variantIdInput = this.querySelector('[data-variant-id]');
        this.galleryMain = this.querySelector('.bundle-gallery__main img');
        this.thumbnails = this.querySelectorAll('.bundle-gallery__thumb');
        
        this.initializeEvents();
      }

      initializeEvents() {
        // Variant option changes
        this.addEventListener('change', this.onOptionChange.bind(this));
        
        // Gallery thumbnails
        this.thumbnails.forEach(thumb => {
          thumb.addEventListener('click', this.onThumbnailClick.bind(this));
        });

        // Form submission
        if (this.form) {
          this.form.addEventListener('submit', this.onFormSubmit.bind(this));
        }
      }

      onOptionChange(event) {
        if (event.target.matches('[name^="option-"]')) {
          this.updateVariant();
        }
      }

      onThumbnailClick(event) {
        const thumb = event.currentTarget;
        const newSrc = thumb.querySelector('img').src.replace('120', '800');
        
        this.thumbnails.forEach(t => t.classList.remove('is-active'));
        thumb.classList.add('is-active');
        
        if (this.galleryMain) {
          this.galleryMain.src = newSrc;
        }
      }

      updateVariant() {
        const options = Array.from(this.querySelectorAll('[name^="option-"]:checked')).map(input => input.value);
        // In a real implementation, this would find the matching variant
        // For now, we'll just update the display
        this.updatePrice();
      }

      updatePrice() {
        // Bundle pricing logic would go here
        // This is a simplified version
        if (this.priceElement) {
          // Price updates would happen here based on selected options
        }
      }

      onFormSubmit(event) {
        event.preventDefault();
        
        const formData = new FormData(this.form);
        const variantId = formData.get('id');
        
        if (!variantId) {
          alert('Please select all options');
          return;
        }

        // Add to cart logic
        fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          // Handle successful add to cart
          document.dispatchEvent(new CustomEvent('cart:added', { detail: data }));
        })
        .catch(error => {
          console.error('Error adding to cart:', error);
        });
      }
    }

    customElements.define('bundle-builder', BundleBuilder);
  </script>

  <style>
    .bundle-builder__grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
      align-items: start;
    }

    @media (max-width: 768px) {
      .bundle-builder__grid {
        grid-template-columns: 1fr;
        gap: 2rem;
      }
    }

    .bundle-gallery__main img {
      width: 100%;
      height: auto;
      border-radius: 0.5rem;
    }

    .bundle-gallery__thumbnails {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
      overflow-x: auto;
    }

    .bundle-gallery__thumb {
      flex: 0 0 auto;
      border: 2px solid transparent;
      border-radius: 0.25rem;
      overflow: hidden;
      background: none;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .bundle-gallery__thumb.is-active,
    .bundle-gallery__thumb:hover {
      border-color: rgb(var(--color-foreground));
    }

    .bundle-option {
      margin-bottom: 1.5rem;
    }

    .bundle-option__legend {
      font-weight: 600;
      margin-bottom: 0.75rem;
      display: block;
    }

    .bundle-option__buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .bundle-option__button {
      padding: 0.75rem 1.5rem;
      border: 1px solid rgb(var(--color-border));
      border-radius: 0.25rem;
      background: rgb(var(--color-background));
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      min-width: 3rem;
    }

    .bundle-option__input:checked + .bundle-option__button {
      background: rgb(var(--color-foreground));
      color: rgb(var(--color-background));
      border-color: rgb(var(--color-foreground));
    }

    .bundle-items {
      background: rgb(var(--color-background));
      border: 1px solid rgb(var(--color-border));
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin: 2rem 0;
    }

    .bundle-items__title {
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .bundle-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid rgb(var(--color-border));
    }

    .bundle-item:last-child {
      border-bottom: none;
    }

    .bundle-item__content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .bundle-item__title {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .bundle-item__description {
      font-size: 0.875rem;
      color: rgb(var(--color-foreground) / 0.7);
      margin: 0;
    }

    .bundle-item__value {
      font-weight: 600;
      color: rgb(var(--color-foreground));
    }

    .bundle-pricing {
      background: rgb(var(--color-background));
      border: 1px solid rgb(var(--color-border));
      border-radius: 0.5rem;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .bundle-pricing__comparison > * {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .bundle-pricing__compare-price {
      text-decoration: line-through;
      color: rgb(var(--color-foreground) / 0.6);
    }

    .bundle-pricing__price {
      font-size: 1.25rem;
      font-weight: 700;
      color: rgb(var(--color-foreground));
    }

    .bundle-pricing__savings {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgb(var(--color-border));
    }

    .bundle-pricing__savings-text {
      color: #16a34a;
      font-weight: 600;
    }

    .bundle-guarantees {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgb(var(--color-border));
    }

    .bundle-guarantee {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .bundle-guarantee__icon {
      font-size: 1rem;
    }
  </style>
{%- endif -%}

{% schema %}
{
  "name": "Bundle Builder",
  "class": "shopify-section--bundle-builder",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "custom.overlay"]
  },
  "settings": [
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:global.colors.scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "separate_section_with_border",
      "label": "t:global.section.separate_section_with_border",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_anchor",
      "label": "Enable Bundle Form Anchor",
      "info": "Creates an anchor point for navigation links",
      "default": true
    },
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "inline_richtext",
      "id": "subheading",
      "label": "t:global.text.subheading"
    },
    {
      "type": "inline_richtext",
      "id": "heading",
      "label": "t:global.text.heading",
      "default": "Complete Your Bundle"
    },
    {
      "type": "richtext",
      "id": "content",
      "label": "t:global.text.content"
    },
    {
      "type": "header",
      "content": "Product"
    },
    {
      "type": "product",
      "id": "product",
      "label": "Bundle Product"
    },
    {
      "type": "text",
      "id": "product_handle",
      "label": "Product Handle",
      "info": "Alternative way to specify product if picker doesn't work"
    },
    {
      "type": "header",
      "content": "Pricing"
    },
    {
      "type": "text",
      "id": "compare_price",
      "label": "Individual Items Price",
      "info": "Price if purchased separately (e.g., 299)"
    },
    {
      "type": "text",
      "id": "savings_amount",
      "label": "Savings Amount",
      "info": "Amount saved with bundle (e.g., 50)"
    },
    {
      "type": "header",
      "content": "Actions"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add Bundle to Cart"
    },
    {
      "type": "checkbox",
      "id": "show_guarantees",
      "label": "Show Guarantees",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "bundle_item",
      "name": "Bundle Item",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon",
          "info": "40x40px recommended"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Sheet Set"
        },
        {
          "type": "text",
          "id": "description",
          "label": "Description",
          "default": "Fitted sheet, flat sheet, and pillowcases"
        },
        {
          "type": "text",
          "id": "value",
          "label": "Value",
          "info": "Optional value display (e.g., '$199')"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Bundle Builder",
      "blocks": [
        {
          "type": "bundle_item",
          "settings": {
            "title": "Sheet Set",
            "description": "Fitted sheet, flat sheet, and pillowcases"
          }
        },
        {
          "type": "bundle_item",
          "settings": {
            "title": "Comforter",
            "description": "All-season eucalyptus comforter"
          }
        },
        {
          "type": "bundle_item",
          "settings": {
            "title": "Pillow Set",
            "description": "Two memory foam pillows"
          }
        }
      ]
    }
  ]
}
{% endschema %}
